% $Id: EHC.lag 199 2004-05-12 19:11:13Z andres $

%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Common AG for Core transformations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Level
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[8
ATTR AllCodeNT [ lev: Int | | ]

SEM CodeAGItf
  | AGItf       module      .   lev         =   cLevOuter

SEM CExpr
  | Lam         loc         .   lev         =   @lhs.lev + 1

SEM CAlt
  | Alt         loc         .   lev         =   @lhs.lev + 1
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Level of id's
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[8
ATTR AllCodeNT [ levMp: LevMp | | ]

SEM CodeAGItf
  | AGItf       module      .   levMp       =   emptyFM

SEM CExpr
  | Lam         body        .   levMp       =   addToFM @lhs.levMp @arg @lev
  | Let         loc         .   maxBindLev  =   fvsLev @lhs.levMp @binds.fvS
                (loc.strLev,binds.levMp)    =   case @categ of
                                                    CBindStrict -> (const @lhs.lev,@lhs.levMp)
                                                    CBindRec    -> (const @maxBindLev,@lhs.levMp `plusFM` (listToFM . zipWith (\l n -> (n,l)) (repeat @maxBindLev) . keysFM $ @binds.levOfMp))
                                                    _           -> (id,@lhs.levMp)
                body        .   levMp       =   @lhs.levMp `plusFM` mapFM (\_ l -> @strLev l) @binds.levOfMp

SEM CAlt
  | Alt         expr        .   levMp       =   addListToFM @lhs.levMp (zip @pats.nmL (repeat @lev))
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Level of expr
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[8
ATTR AllCodeNT [ | | levOf USE {`max`} {0}: Int ]

SEM CExpr
  | Var         lhs         .   levOf       =   lookupWithDefaultFM @lhs.levMp cLevOuter @nm
  | App         loc         .   levOf       =   @func.levOf `max` @arg.levOf
  | Case        loc         .   levOf       =   @expr.levOf `max` @alts.levOf `max` @dflt.levOf
  | TupSel TupDel
                loc         .   levOf       =   @expr.levOf `max` @offset.levOf
  | TupIns TupUpd
                loc         .   levOf       =   @expr.levOf `max` @offset.levOf `max` @fldExpr.levOf
  | Lam         loc         .   levOf       =   fvsLev @lhs.levMp @body.fvS

SEM CAlt
  | Alt         lhs         .   levOf       =   fvsLev @lhs.levMp @expr.fvS

ATTR AllBind [ | | levOfMp USE {`plusFM`} {emptyFM}: LevMp ]

SEM CBind
  | Bind        lhs         .   levOfMp     =   unitFM @nm @expr.levOf
%%]

