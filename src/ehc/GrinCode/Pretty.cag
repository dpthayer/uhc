%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Haskell importable interface to Code's Java gen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Pretty print GrinCode.

Tricky (in version 12):
Printing names depends on the printing context. ppGrNm factors this out, but for GrExpr's printed as part
if .hi interface files ppGrExpr requires a parameterised variant which prints names as required for .hi files.

%%[8 hs module {%{EH}GrinCode.Pretty} import(UU.Pretty,EH.Util.PPUtils,{%{EH}Base.Common},{%{EH}GrinCode},{%{EH}GrinCode.Parser},{%{EH}Scanner.Common(grinScanOpts)})
%%]

%%[8 hs export(ppGrModule,ppGrExpr,ppGrExpr',ppGrPat,ppGrTag)
%%]

%%[8.WRAPPER ag import({GrinCode/AbsSyn})
WRAPPER GrAGItf GrExpr GrPat GrTag
%%]

%%[8 hs
ppGrModule :: GrModule -> PP_Doc
ppGrModule cmod
  =  let  t = wrap_GrAGItf  (sem_GrAGItf (GrAGItf_AGItf cmod))
                            (Inh_GrAGItf )
     in   (pp_Syn_GrAGItf t)


ppGrTag :: GrTag -> PP_Doc
ppGrTag tg
  =  let  t = wrap_GrTag  (sem_GrTag tg)
                          (Inh_GrTag
                             { ppGrNm_Inh_GrTag = ppGrNm
                             })
     in   (pp_Syn_GrTag t)

ppGrExpr' :: PPGrNm -> GrExpr -> PP_Doc
ppGrExpr' ppGrNm tg
  =  let  t = wrap_GrExpr  (sem_GrExpr tg)
                           (Inh_GrExpr
                             { ppGrNm_Inh_GrExpr = ppGrNm
                             })
     in   (pp_Syn_GrExpr t)

ppGrExpr :: GrExpr -> PP_Doc
ppGrExpr = ppGrExpr' ppGrNm

ppGrPat :: GrPat -> PP_Doc
ppGrPat tg
  =  let  t = wrap_GrPat  (sem_GrPat tg)
                          (Inh_GrPat
                             { ppGrNm_Inh_GrPat = ppGrNm
                             })
     in   (pp_Syn_GrPat t)

%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Config how to print names
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[8
ATTR AllWithName [ ppGrNm: PPGrNm | | ]

SEM GrBind
  | Bind        loc         .   ppGrNm      =   ppGrNm

SEM GrGlobal
  | Global      loc         .   ppGrNm      =   ppGrNm
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Pretty printed code
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[8 hs
type PPGrNm = HsName -> PP_Doc

ppCurlysSemisV :: [PP_Doc] -> PP_Doc
ppCurlysSemisV pL = pp_block "{ " "} " "; " pL

ppGrNm :: PPGrNm
ppGrNm = ppHsnNonAlpha grinScanOpts

ppEvApTagElt :: EvApTagElt -> PP_Doc
ppEvApTagElt e
  =  case e of
        EvApTagTag t  -> ppGrTag t
        EvApTagVar n  -> ppGrNm n
        EvApTagUnit   -> pp "unit"
        EvApTagThrow  -> pp "throw"

ppEvApTagMp :: EvApTagMp -> PP_Doc
ppEvApTagMp m
  =  ppCurlysSemisV
        (map  (\((tag,arity),evap)
                  ->  ppGrTag tag >#< pp arity >#< "->" >#< ppEvApTagElt evap >-< ""
              )
              m
        )      
%%]

%%[8
ATTR GrAGItf AllNT [ | | pp USE {>-<} {empty}: PP_Doc ]

SEM GrModule
  | Mod         lhs         .   pp          =   "module" >#< ppGrNm @moduleNm
                                                >-< ppCurlysSemisV @globalL.ppL
                                                >-< ppCurlysSemisV @bindL.ppL
                                                >-< "ctags"
                                                >-< ppCurlysSemisV
                                                         (map  (\(tn,ts)
                                                                    ->  ppGrNm tn >#< "="
                                                                        >#< ( ppListSep "" "" " | "
                                                                            . map  (\(n,CTag _ _ t a ma) -> ppGrNm n >#< t >#< a >#< ma)
                                                                            $ ts
                                                                            )
                                                                        >-< ""    
                                                               )
                                                               @ctagsMp)
                                                >-< "evalmap"
                                                >-< ppEvApTagMp @evalTagMp
                                                >-< "applymap"
                                                >-< ppEvApTagMp @applyTagMp


SEM GrGlobal
  | Global      lhs         .   pp          =   ppGrNm @nm >#< "<-" >#< "store" >#< @val.pp

SEM GrBind
  | Bind        lhs         .   pp          =   ppGrNm @nm >#< ppSpaced (map ppGrNm @argNmL) >-<
                                                    indent 2 ("=" >#< ppCurlysSemisV [@expr.pp])
  | Rec         lhs         .   pp          =   "rec" >-< indent 2 (ppCurlysSemisV @bindL.ppL)

SEM GrExpr
  | Seq         lhs         .   pp          =   @expr.pp >#< ";" >#< "\\" >|< @pat.pp >#< "->"
                                                >-< @body.pp
  | Case        lhs         .   pp          =   "case" >#< @val.pp >#< "of" >-<
                                                    indent 2 (ppCurlysSemisV @altL.ppL)
  | App         lhs         .   pp          =   "apply" >#< ppSpaced (@lhs.ppGrNm @nm : @argL.ppL)
  | Call        lhs         .   pp          =   ppSpaced (@lhs.ppGrNm @nm : @argL.ppL)
  | FFI         lhs         .   pp          =   "ffi" >#< ppSpaced (pp @nm : map @lhs.ppGrNm @argL) >#< ppCurlysSemisV @resTagL.ppL
  | Eval        lhs         .   pp          =   "eval" >#< @lhs.ppGrNm @nm
  | Unit        lhs         .   pp          =   "unit" >#< @val.pp
  | UpdateUnit  lhs         .   pp          =   "updateunit" >#< @val.pp >#< ppGrNm @nm
  | Store       lhs         .   pp          =   "store" >#< @val.pp
  | FetchNode   lhs         .   pp          =   "fetchnode"  >#<  @lhs.ppGrNm @nm 
  | FetchField  lhs         .   pp          =   "fetchfield" >#<  @lhs.ppGrNm @nm >#< pp @offset >#< maybe empty ppGrTag @mbTag
  | FetchUpdate lhs         .   pp          =   "fetchupdate" >#< @lhs.ppGrNm @src >#< @lhs.ppGrNm @dst
  | Throw       lhs         .   pp          =   "throw" >#< @lhs.ppGrNm @nm
  | Catch       lhs         .   pp          =   "try" >-<
                                                indent 2 (ppCurlysSemisV [@body.pp]) >-<
                                                "catch" >|< pp_parens (@lhs.ppGrNm @arg) >-<
                                                indent 2 (ppCurlysSemisV [@handler.pp])

SEM GrAlt
  | Alt         lhs         .   pp          =   @pat.pp >-< indent 2 ("->" >#< ppCurlysSemisV [@expr.pp])

SEM GrVal
  | Empty       lhs         .   pp          =   pp "()"
  | LitInt      lhs         .   pp          =   pp @int
  | LitStr      lhs         .   pp          =   pp $ show @str
  | Var         lhs         .   pp          =   @lhs.ppGrNm @nm
  | Node        lhs         .   pp          =   ppListSep "(" ")" " " (@tag.pp : @fldL.ppL)
%%[[10
  | NodeAdapt   lhs         .   pp          =   pp_parens (@lhs.ppGrNm @nm >|< "|" >|< (ppListSep "" "" "," @fldL.ppL))

SEM GrAdapt
  | Upd         lhs         .   pp          =   @off.pp >|< ":=" >|< @val.pp
  | Ins         lhs         .   pp          =   @off.pp >|< "+=" >|< @val.pp
  | Del         lhs         .   pp          =   @off.pp >|< "-="
%%]]

SEM GrPat
  | Empty       lhs         .   pp          =   pp "()"
  | LitInt      lhs         .   pp          =   pp @int
  | Var         lhs         .   pp          =   @lhs.ppGrNm @nm
  | Node        lhs         .   pp          =   ppListSep "(" ")" " " (@tag.pp : map @lhs.ppGrNm @fldL)
%%[[10
  | NodeSplit   lhs         .   pp          =   pp_parens (@tag.pp >#< @lhs.ppGrNm @nm >|< "|" >|< (ppListSep "" "" "," @fldL.ppL))

SEM GrSplit
  | Sel         lhs         .   pp          =   @lhs.ppGrNm @nm >|< "=" >|< @off.pp
%%]]


SEM GrTag
  | Lit         lhs         .   pp          =   "#" >|< @int >|< "/" >|< pp @categ >|< "/" >|< @lhs.ppGrNm @nm
  | Var         lhs         .   pp          =   @lhs.ppGrNm @nm
  | Unboxed     lhs         .   pp          =   pp "#U"
  | Any         lhs         .   pp          =   pp "#*"
%%]

%%[8
ATTR GrGlobalL GrBindL GrAltL GrTagL GrPatL GrValL [ | | ppL: {[PP_Doc]} ]

SEM GrGlobalL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrBindL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrAltL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrTagL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrPatL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrValL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []
%%]
%%[10
ATTR GrAdaptL GrSplitL [ | | ppL: {[PP_Doc]} ]

SEM GrAdaptL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []

SEM GrSplitL
  | Cons        lhs         .   ppL         =   @hd.pp : @tl.ppL
  | Nil         lhs         .   ppL         =   []
%%]
