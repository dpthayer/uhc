-------------------------------------------------------------------------
-- Convert Text to DocLaTeX
-------------------------------------------------------------------------

{
module Text.To.DocLaTeX
  ( textToOutDoc
  )
  where

import qualified Data.Map as Map
import qualified Data.Set as Set

-- import EH.Util.Pretty
import qualified EH.Util.FastSeq as Seq
import EH.Util.ScanUtils

import Common
import Text
}

-------------------------------------------------------------------------
-- Interfacing
-------------------------------------------------------------------------

WRAPPER AGItf

{
textToOutDoc :: Opts -> AGItf -> OutDoc
textToOutDoc opts txt
  = out_Syn_AGItf t
  where t = wrap_AGItf (sem_AGItf txt)
                       (Inh_AGItf { opts_Inh_AGItf = opts
                                  })
}

-------------------------------------------------------------------------
-- AST
-------------------------------------------------------------------------

INCLUDE "Text/AbsSyn.ag"
INCLUDE "Text/To/Common.ag"

-------------------------------------------------------------------------
-- Combinators
-------------------------------------------------------------------------

{
dltxCmd :: Out c => c -> OutDoc
dltxCmd c = "\\" +++ c

dltxArg :: Out a => a -> OutDoc
dltxArg a = "{" +++ a +++ "}"

dltxArgs :: [OutDoc] -> OutDoc
dltxArgs a = outList $ map dltxArg a

dltxBeginEnd :: (Out body, Out env) => env -> body -> OutDoc
dltxBeginEnd env body = dltxCmd "begin" +++ dltxArg env +++ body +++ dltxCmd "end" +++ dltxArg env
}

-------------------------------------------------------------------------
-- Global info
-------------------------------------------------------------------------

ATTR AGItf AllNT [ opts: Opts | | ]

-------------------------------------------------------------------------
-- Replacement, as OutDoc
-------------------------------------------------------------------------

ATTR AGItf AllNT [ | | out USE {+++} {emptyout}: OutDoc ]

SEM TextItem
  | Space  			loc			.	out			=   out @str
  | NonSpace  		loc			.	out			=   out @str
  | CommentLF		loc			.	out			=   "%" +++ @str +++ "\n"
  | Line  			loc			.	out			=   @str +++ "\n"
  | LineFeed		loc			.	out			=   out "\n"
  | ParBreak		loc			.	out			=   out "\n\n"
  | T2T  			loc			.	out			=   ("@@[" +++ show @texttype) +++ "should not happen!!" +++ "@@]"	-- for now
  | RefTo	  		loc			.	out			=   @reftype.out +++ dltxArgs [@reftext.out, @text.out]
  | Styled	  		loc			.	out			=   @style.out +++ dltxArg @text.out
  | VerbatimInline	loc			.	out			=   dltxCmd "verb" +++ @delim +++ @str +++ @delim
  | BreakLine		loc			.	out			=   dltxCmd "\\"
  | HorRuler		loc			.	out			=   dltxCmd "hline"
  | Header  		loc			.	out			=   @level.out +++ dltxArg @text.out
  | Group			loc			.	out			=	dltxBeginEnd @envtype.out @text.out
  | DocumentContent	loc			.	out			=	dltxBeginEnd "document" @text.out
  | Table			loc			.	out			=	dltxBeginEnd "tabular" (dltxArg @tablefmt.out +++ @extratext.out +++ @rows.out)
  | Itemize			loc			.	out			=	dltxBeginEnd @itemizestyle.out @text.out
  | ItemizeItem		loc			.	out			=	dltxCmd "item" +++ @text.out
  | Title   		loc			.	out			=	dltxCmd "title" +++ dltxArg @text.out
  | Author   		loc			.	out			=	dltxCmd "author" +++ dltxArg @text.out
  | Import   		loc			.	out			=	dltxCmd "usepackage" +++ dltxArg @text.out
  | Label   		loc			.	out			=	dltxCmd "label" +++ dltxArg @reftext.out
  | MakeTitle		loc			.	out			=   dltxCmd "maketitle"
  | DocumentHeader	loc			.	out			=   dltxCmd "documentclass" +++ @mboptions.out +++ dltxArg @text.out
  | GraphicsInline	loc			.	out			=   dltxCmd "includegraphics" +++ @mboptions.out +++ dltxArg @text.out
  | TOC				loc			.	out			=   dltxCmd "tableofcontents"
  
SEM RefType
  | Local			loc			.	out			=	dltxCmd "lref"
  | Global			loc			.	out			=	dltxCmd "href"
  | EhcWeb			loc			.	out			=	dltxCmd "eref"
  | EhcSrc			loc			.	out			=	dltxCmd "sref"

SEM TextStyle
  -- | Verbatim		loc			.	out			=	dltxCmd "verb"
  | Bold			loc			.	out			=	dltxCmd "textbf"
  | Italic			loc			.	out			=	dltxCmd "textit"
  | Teletype		loc			.	out			=	dltxCmd "texttt"
  | Emphasized		loc			.	out			=	dltxCmd "emph"

SEM GroupType
  | Verbatim		lhs			.	out			=	out "pre"
  -- | Document		lhs			.	out			=	out "document"
  -- | Tabular			lhs			.	out			=	out "tabular"

SEM ItemizeStyle
  | Bullet			lhs			.	out			=	out "itemize"
  | Number			lhs			.	out			=	out "enumerate"

SEM HeaderLevel
  | Level			lhs			.	out			=	dltxCmd (outList (replicate @level "sub") +++ "section")
  | Paragraph		lhs			.	out			=	dltxCmd "paragraph"

SEM DocumentOption
  | A4Paper			loc			.	out			=	out "a4paper"

SEM MbDocumentOptions
  | Just			loc			.	out			=	outListSep "[" "]" "," @just.outL

SEM GraphicsInlineOption
  | Scale			loc			.	out			=	"scale=" +++ @text.out

SEM MbGraphicsInlineOptions
  | Just			loc			.	out			=	outListSep "[" "]" "," @just.outL

SEM TableColFormat
  | JustifyLeft		loc			.	out			=	out "l"
  | JustifyCenter	loc			.	out			=	out "c"
  | JustifyRight	loc			.	out			=	out "r"
  | SepbyLine		loc			.	out			=	out "|"

SEM TableRow
  | Row				lhs			.	out			=	outListSep "" "" "&" @cols.outL +++ "\\\\" +++ @extrabrktext.out

SEM TableField
  | Fld				lhs			.	out			=	@extraseptext.out +++ @fld.out

-------------------------------------------------------------------------
-- Replacement, as [OutDoc]
-------------------------------------------------------------------------

ATTR
  DocumentOptions DocumentOption
  GraphicsInlineOptions GraphicsInlineOption
  TableFields
    [ | | outL USE {++} {[]}: {[OutDoc]} ]

SEM DocumentOption GraphicsInlineOption
  | *				lhs			.	outL		=	[@out]

SEM TableFields
  | Cons			lhs			.	outL		=	@hd.out : @tl.outL
  | Nil				lhs			.	outL		=	[]
